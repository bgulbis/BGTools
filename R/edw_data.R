# edw_data.R

#' Read EDW data from csv files
#'
#' \code{read_edw_data} takes a directory and file name and reads in all
#' matching csv files and binds them together into a data frame
#'
#' This function takes a directory and file name and reads in all
#' matching csv files and binds them together into a data frame.
#'
#'
#' @param data.dir A character string with the name of the directory containing the
#'   data files
#' @param file.name A character string with name of data file or pattern to match
#' @param type An optional character string indicating type of data being tidied
#'
#' @return A data frame
#'
#' @export
read_edw_data <- function(data.dir, file.name, type = NA) {
    # if type is NA, then set type to file.name
    if (is.na(type)) {
        type <- file.name
    }

    raw <- read_data(data.dir, file.name)

    tidy <- tidy_edw_data(raw, type)

    return(tidy)
}

#' Read and join data from multiple csv files
#'
#' \code{read_data} takes a directory and file name and reads in all matching
#' csv files and binds them together into a data frame
#'
#' This function takes a directory and file name and reads in all matching csv
#' files and binds them together into a data frame.
#'
#' @param data.dir A character string with the name of the directory containing the
#'   data files
#' @param file.name A character string with name of data file or pattern to match
#'
#' @return A data frame
#'
#' @export
read_data <- function(data.dir, file.name) {
    # get list of files is specified directory and matching file name
    raw <- list.files(data.dir, pattern = file.name, full.names = TRUE)
    # loop through all matching files and read in to list
    raw <- lapply(raw, read.csv, colClasses = "character")
    # take list of files and bind them together into a data frame
    raw <- dplyr::bind_rows(raw)
    # remove any duplicate rows
    raw <- dplyr::distinct_(raw)

    return(raw)
}

#' Tidy data from EDW
#'
#' \code{tidy_edw_data} takes a data frame with raw data from EDW and returns a
#' tidied data frame
#'
#' This function takes a data frame with raw data generated by an EDW query, and
#' a character vector indicating the type of data being tidied, and will return
#' a tidied data frame. Valid options for type include: blood, demographics,
#' diagnosis, home_meds, icu_score, labs, location, measures, meds_continuous,
#' meds_freq, meds_sched, meds_sched_freq, mpp, procedures, surgeries,
#' radiology, vent, vitals, warfarin.
#'
#'
#' @param raw.data A data frame with raw data from EDW
#' @param type A character vector indicating the type of data being tidied
#'
#' @return A data frame
#'
tidy_edw_data <- function(raw.data, type) {

    # set field modifications (dots) and names of columns (nm)
    if (type == "blood") {
        dots <- list("PowerInsight.Encounter.Id",
                     ~lubridate::ymd_hms(Clinical.Event.End.Date.Time),
                     ~factor(Clinical.Event),
                     "Clinical.Event.Result")
        nm <- c("pie.id", "blood.datetime", "blood.prod", "blood.type")

    } else if (type == "demographics") {
        dots <- list("PowerInsight.Encounter.Id",
                     "Person.ID",
                     ~as.numeric(Age..Years..Visit.),
                     ~factor(Sex, exclude = c("", "Unknown")),
                     ~factor(Race, exclude = c("", "Unknown")),
                     ~factor(Discharge.Disposition),
                     ~as.numeric(LOS..Actual.),
                     ~factor(Encounter.Type))
        nm <- c("pie.id", "person.id", "age", "sex", "race", "disposition",
                "los", "visit.type")

    } else if (type == "diagnosis") {
        dots <- list("PowerInsight.Encounter.Id",
                     "ICD9.Diagnosis.Code",
                     ~factor(Diagnosis.Type, exclude = ""),
                     ~factor(Diagnosis.Code.Sequence))
        nm <- c("pie.id", "diag.code", "diag.type", "diag.seq")

    } else if (type == "home_meds") {
        dots <- list("PowerInsight.Encounter.Id",
                     "Order.Catalog.Short.Description",
                     "Order.Catalog.Mnemonic",
                     ~factor(Orig.Orderable.Type.Flag.Desc))
        nm <- c("pie.id", "med", "order.name", "med.type")

    } else if (type == "labs") {
        dots <- list("PowerInsight.Encounter.Id",
                     ~lubridate::ymd_hms(Clinical.Event.End.Date.Time),
                     "Clinical.Event",
                     "Clinical.Event.Result")
        nm <- c("pie.id", "lab.datetime", "lab", "lab.result")

    } else if (type == "measures") {
        dots <- list("PowerInsight.Encounter.Id",
                     ~lubridate::ymd_hms(Clinical.Event.End.Date.Time),
                     "Clinical.Event",
                     ~as.numeric(Clinical.Event.Result),
                     ~factor(Clinical.Event.Result.Units))
        nm <- c("pie.id", "measure.datetime", "measure", "measure.result",
                "measure.units")

    } else if (type == "meds_continuous") {
        dots <- list("PowerInsight.Encounter.Id",
                     ~lubridate::ymd_hms(Clinical.Event.End.Date.Time),
                     "Clinical.Event",
                     ~as.numeric(Infusion.Rate),
                     ~factor(Infusion.Rate.Unit, exclude = ""),
                     "Event.ID")
        nm <- c("pie.id", "med.datetime", "med", "med.rate", "med.rate.units",
                "event.id")

    } else if (type == "meds_sched") {
        dots <- list("PowerInsight.Encounter.Id",
                     ~lubridate::ymd_hms(Clinical.Event.End.Date.Time),
                     "Clinical.Event",
                     ~as.numeric(Dosage.Amount),
                     ~factor(Dosage.Unit, exclude = ""),
                     ~factor(Route.of.Administration...Short, exclude = ""),
                     "Event.ID")
        nm <- c("pie.id", "med.datetime", "med", "med.dose", "med.dose.units",
                "med.route", "event.id")

    } else if (type == "meds_sched_freq") {
        dots <- list("PowerInsight.Encounter.Id",
                     ~lubridate::ymd_hms(Clinical.Event.End.Date.Time),
                     "Clinical.Event",
                     ~as.numeric(Dosage.Amount),
                     ~factor(Dosage.Unit, exclude = ""),
                     ~factor(Route.of.Administration...Short, exclude = ""),
                     "Parent.Order.Frequency.Description",
                     "Event.ID")
        nm <- c("pie.id", "med.datetime", "med", "med.dose", "med.dose.units",
                "med.route", "freq", "event.id")

    } else if (type == "procedures") {
        dots <- list("PowerInsight.Encounter.Id",
                     ~lubridate::ymd_hms(Procedure.Date.and.Time),
                     "ICD9.Procedure.Code")
        nm <- c("pie.id", "proc.date", "proc.code")

    } else if (type == "radiology") {
        dots <- list("PowerInsight.Encounter.Id",
                     ~lubridate::ymd_hms(Clinical.Event.End.Date.Time),
                     "Clinical.Event")
        nm <- c("pie.id", "rad.datetime", "rad.type")

    } else if (type == "surgeries") {
        dots <- list("PowerInsight.Encounter.Id",
                     ~lubridate::ymd_hms(Start.Date.Time),
                     ~lubridate::ymd_hms(Stop.Date.Time),
                     "Procedure",
                     ~ifelse(Add.On.Indicator == 1, TRUE, FALSE),
                     ~factor(ASA.Class, exclude = ""),
                     ~ifelse(Primary.Procedure.Indicator == 1, TRUE, FALSE))
        nm <- c("pie.id", "surg.start.datetime", "surg.stop.datetime",
                "surgery", "add.on", "asa.class", "primary.proc")

    } else {
        print("Invalid type")
        return(NULL)
    }

    # apply the parameters to the columns, remove any remaining columns
    tidy.data <- dplyr::transmute_(raw.data, .dots = setNames(dots, nm))

    return(tidy.data)
}

